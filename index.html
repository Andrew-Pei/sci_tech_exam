<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆä¸€ç§‘æŠ€æœŸæœ«è€ƒè¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .student-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .student-info h2 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .timer {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid #ffc107;
        }

        .timer h2 {
            color: #856404;
            font-size: 20px;
        }

        .timer #timer {
            font-size: 28px;
            font-weight: bold;
            color: #dc3545;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .question-section {
            margin-bottom: 40px;
        }

        .question-section h2 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }

        .question:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .question h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .question-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            margin-right: 10px;
            font-size: 14px;
        }

        .options {
            margin-left: 40px;
        }

        .option {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .option:hover {
            background: #e9ecef;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        .option input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: bold;
        }

        .option.selected {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .result {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-top: 30px;
        }

        .result h2 {
            font-size: 32px;
            margin-bottom: 20px;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .result-details {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .result-details p {
            margin: 10px 0;
            font-size: 18px;
        }

        .correct-answers {
            color: #4ade80;
        }

        .wrong-answers {
            color: #f87171;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .question h3 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ åˆä¸€ç§‘æŠ€æœŸæœ«è€ƒè¯•</h1>
        
        <div class="student-info">
            <h2>ğŸ“ å­¦ç”Ÿä¿¡æ¯</h2>
            <div class="form-group">
                <label for="studentName">å§“åï¼š</label>
                <input type="text" id="studentName" placeholder="è¯·è¾“å…¥ä½ çš„å§“å" required>
            </div>
            <div class="form-group">
                <label for="studentClass">ç­çº§ï¼š</label>
                <input type="text" id="studentClass" placeholder="ä¾‹å¦‚ï¼š3" required>
            </div>
            <div class="form-group">
                <label for="studentNumber">å­¦å·ï¼š</label>
                <input type="text" id="studentNumber" placeholder="è¯·è¾“å…¥ä½ çš„å­¦å·" required>
            </div>
        </div>

        <div class="timer">
            <h2>â±ï¸ å‰©ä½™æ—¶é—´ï¼š<span id="timer">30:00</span></h2>
        </div>

        <form id="examForm">
            <div class="question-section">
                <h2>ä¸€ã€é€‰æ‹©é¢˜ï¼ˆæ¯é¢˜2åˆ†ï¼Œå…±60åˆ†ï¼‰</h2>
                <div id="choiceQuestions"></div>
            </div>

            <div class="question-section">
                <h2>äºŒã€åˆ¤æ–­é¢˜ï¼ˆæ¯é¢˜2åˆ†ï¼Œå…±40åˆ†ï¼‰</h2>
                <div id="judgeQuestions"></div>
            </div>

            <button type="submit" class="submit-btn">ğŸ“¤ æäº¤ç­”æ¡ˆ</button>
        </form>

        <div class="result" id="result">
            <h2>ğŸ‰ è€ƒè¯•å®Œæˆï¼</h2>
            <div class="score" id="finalScore">0</div>
            <div class="result-details">
                <p id="studentInfo"></p>
                <p class="correct-answers">âœ… æ­£ç¡®ï¼š<span id="correctCount">0</span> é¢˜</p>
                <p class="wrong-answers">âŒ é”™è¯¯ï¼š<span id="wrongCount">0</span> é¢˜</p>
                <p>âšª æœªç­”ï¼š<span id="unansweredCount">0</span> é¢˜</p>
                <p>ğŸ“Š æ€»åˆ†ï¼š<span id="totalScore">0</span>/100 åˆ†</p>
            </div>
        </div>
    </div>

    <script>
        // é¢˜ç›®æ•°æ®
        let allChoiceQuestions = [];
        let allJudgeQuestions = [];
        let choiceQuestions = [];
        let judgeQuestions = [];

        // éšæœºæ’åºæ•°ç»„
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // ä»æœåŠ¡å™¨åŠ è½½é¢˜ç›®
        async function loadQuestions() {
            try {
                const response = await fetch('/api/questions');
                if (!response.ok) {
                    throw new Error('åŠ è½½é¢˜ç›®å¤±è´¥');
                }
                const data = await response.json();
                allChoiceQuestions = data.choiceQuestions || [];
                allJudgeQuestions = data.judgeQuestions || [];
                
                // éšæœºæ‰“ä¹±é¢˜ç›®
                choiceQuestions = shuffleArray(allChoiceQuestions);
                judgeQuestions = shuffleArray(allJudgeQuestions);
                
                // æ¸²æŸ“é¢˜ç›®
                renderChoiceQuestions();
                renderJudgeQuestions();
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®é”™è¯¯ï¼š', error);
                alert('åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // è€ƒè¯•æ—¶é—´é™åˆ¶ï¼ˆ30åˆ†é’Ÿ = 1800ç§’ï¼‰
        const examTime = 1800;
        let timeRemaining = examTime;
        let timerInterval;

        // æ¸²æŸ“é€‰æ‹©é¢˜
        function renderChoiceQuestions() {
            const container = document.getElementById('choiceQuestions');
            choiceQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <h3><span class="question-number">${index + 1}</span>${q.question}</h3>
                    <div class="options">
                        ${q.options.map((opt, i) => `
                            <div class="option" onclick="selectOption(this, 'choice${index}')">
                                <input type="radio" name="choice${index}" value="${opt.charAt(0)}" id="choice${index}_${i}">
                                <span>${opt}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }

        // æ¸²æŸ“åˆ¤æ–­é¢˜
        function renderJudgeQuestions() {
            const container = document.getElementById('judgeQuestions');
            judgeQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <h3><span class="question-number">${index + 1}</span>${q.question}</h3>
                    <div class="options">
                        <div class="option" onclick="selectOption(this, 'judge${index}')">
                            <input type="radio" name="judge${index}" value="true" id="judge${index}_true">
                            <span>âœ… æ­£ç¡®</span>
                        </div>
                        <div class="option" onclick="selectOption(this, 'judge${index}')">
                            <input type="radio" name="judge${index}" value="false" id="judge${index}_false">
                            <span>âŒ é”™è¯¯</span>
                        </div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(element, name) {
            const options = document.querySelectorAll(`input[name="${name}"]`);
            options.forEach(opt => {
                opt.parentElement.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                alert('è€ƒè¯•æ—¶é—´åˆ°ï¼ç³»ç»Ÿå°†è‡ªåŠ¨æäº¤ä½ çš„ç­”æ¡ˆã€‚');
                submitExam();
            } else {
                timeRemaining--;
            }
        }

        // æäº¤ç­”æ¡ˆ
        function submitExam() {
            // è·å–å­¦ç”Ÿä¿¡æ¯
            const name = document.getElementById('studentName').value;
            const className = document.getElementById('studentClass').value;
            const number = document.getElementById('studentNumber').value;

            if (!name || !className || !number) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å­¦ç”Ÿä¿¡æ¯ï¼');
                return;
            }

            let choiceCorrectCount = 0;
            let choiceWrongCount = 0;
            let choiceUnansweredCount = 0;
            let judgeCorrectCount = 0;
            let judgeWrongCount = 0;
            let judgeUnansweredCount = 0;

            // æ£€æŸ¥é€‰æ‹©é¢˜
            choiceQuestions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="choice${index}"]:checked`);
                if (selected) {
                    if (selected.value === q.answer) {
                        choiceCorrectCount++;
                    } else {
                        choiceWrongCount++;
                    }
                } else {
                    choiceUnansweredCount++;
                }
            });

            // æ£€æŸ¥åˆ¤æ–­é¢˜
            judgeQuestions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="judge${index}"]:checked`);
                if (selected) {
                    if (selected.value === String(q.answer)) {
                        judgeCorrectCount++;
                    } else {
                        judgeWrongCount++;
                    }
                } else {
                    judgeUnansweredCount++;
                }
            });

            const correctCount = choiceCorrectCount + judgeCorrectCount;
            const wrongCount = choiceWrongCount + judgeWrongCount;
            const unansweredCount = choiceUnansweredCount + judgeUnansweredCount;

            // è®¡ç®—åˆ†æ•°ï¼ˆé€‰æ‹©é¢˜30é“ï¼Œæ¯é¢˜2åˆ†ï¼Œå…±60åˆ†ï¼›åˆ¤æ–­é¢˜20é“ï¼Œæ¯é¢˜2åˆ†ï¼Œå…±40åˆ†ï¼›æ€»åˆ†100åˆ†ï¼‰
            const choiceScore = choiceCorrectCount * 2;
            const judgeScore = judgeCorrectCount * 2;
            const totalScore = Math.round(choiceScore + judgeScore);

            // å‡†å¤‡æäº¤æ•°æ®
            const examData = {
                name: name,
                className: className,
                studentNumber: number,
                score: totalScore,
                choiceCorrectCount: choiceCorrectCount,
                choiceWrongCount: choiceWrongCount,
                choiceUnansweredCount: choiceUnansweredCount,
                judgeCorrectCount: judgeCorrectCount,
                judgeWrongCount: judgeWrongCount,
                judgeUnansweredCount: judgeUnansweredCount,
                correctCount: correctCount,
                wrongCount: wrongCount,
                unansweredCount: unansweredCount,
                submitTime: new Date().toISOString(),
                timeUsed: examTime - timeRemaining
            };

            // æäº¤åˆ°åç«¯
            fetch('/api/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(examData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'æäº¤å¤±è´¥');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('æˆç»©æäº¤æˆåŠŸï¼š', data);
                if (data.submitCount && data.submitCount > 1) {
                    alert(`æˆç»©æ›´æ–°æˆåŠŸï¼è¿™æ˜¯ç¬¬ ${data.submitCount} æ¬¡æäº¤ï¼ˆæœ€å¤š3æ¬¡ï¼‰`);
                } else {
                    alert('æˆç»©æäº¤æˆåŠŸï¼');
                }
                displayResult(examData);
            })
            .catch(error => {
                console.error('æäº¤å¤±è´¥ï¼š', error);
                alert('æˆç»©æäº¤å¤±è´¥ï¼š' + error.message + '\nä½†ä½ çš„æˆç»©å·²è®¡ç®—å®Œæˆã€‚');
                displayResult(examData);
            });
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(examData) {
            document.getElementById('studentInfo').innerHTML = `
                ğŸ‘¤ å§“åï¼š${examData.name}<br>
                ğŸ« ç­çº§ï¼š${examData.className}<br>
                ğŸ†” å­¦å·ï¼š${examData.studentNumber}
            `;
            document.getElementById('correctCount').textContent = examData.correctCount;
            document.getElementById('wrongCount').textContent = examData.wrongCount;
            document.getElementById('unansweredCount').textContent = examData.unansweredCount;
            document.getElementById('totalScore').textContent = examData.score;
            document.getElementById('finalScore').textContent = examData.score + 'åˆ†';

            document.getElementById('examForm').style.display = 'none';
            document.getElementById('result').style.display = 'block';
        }

        // è¡¨å•æäº¤äº‹ä»¶
        document.getElementById('examForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (confirm('ç¡®å®šè¦æäº¤ç­”æ¡ˆå—ï¼Ÿæäº¤åæ— æ³•ä¿®æ”¹ï¼')) {
                clearInterval(timerInterval);
                submitExam();
            }
        });

        // åˆå§‹åŒ–
        loadQuestions().then(() => {
            timerInterval = setInterval(updateTimer, 1000);
        });
    </script>
</body>
</html>
